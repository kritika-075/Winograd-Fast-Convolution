# -*- coding: utf-8 -*-
"""Winograd.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1ao80NV_bGIxitl9fRiq35H3yp0F8vD-z
"""

import numpy as np
import math

m = 2
r = 3
alpha = m + r - 1

H = 8
W = 8
K = 2
C = 3
N = 2
P = N * math.ceil(H/m) * math.ceil(W/m)

G = np.array([
    [1, 0, 0],
    [0.5, 0.5, 0.5],
    [0.5, -0.5, 0.5],
    [0, 0, 1]
    ])

B = np.array([
    [1, 0, 0, 0],
    [0, 1, -1, 1],
    [-1, 1, 1, 0],
    [0, 0, 0, -1]
    ])

A = np.array([
    [1, 0],
    [1, 1],
    [1, -1],
    [0, -1]
    ])

D = np.array([
    [
        [
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10]
        ],
        [
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10]
        ],
        [
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10]
        ]
    ],
    [
        [
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10]
        ],
        [
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10]
        ],
        [
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10],
            [1,2,3,4,5,6,7,8,9,10]
        ]
    ]
])

g = np.array([
    [
        [
            [1,1,1],
            [1,1,1],
            [1,1,1]
        ],
        [
            [2,2,2],
            [2,2,2],
            [2,2,2]
        ],
        [
            [3,3,3],
            [3,3,3],
            [3,3,3]
        ],
    ],
    [
        [
            [4,4,4],
            [4,4,4],
            [4,4,4]
        ],
        [
            [5,5,5],
            [5,5,5],
            [5,5,5]
        ],
        [
            [6,6,6],
            [6,6,6],
            [6,6,6]
        ]
    ]
])

U = np.empty(shape=(alpha, alpha, K, C))
for k in range(K):
    for c in range(C):
        u = G.dot(g[k][c]).dot(G.T)
        # scatter
        for xi in range(alpha):
            for nu in range(alpha):
                U[xi][nu][k][c] = u[xi][nu]

V = np.empty(shape=(alpha, alpha, C, P))
for i in range(N):
    for c in range(C):
        for y in range(math.ceil(H/m)):
            for x in range(math.ceil(W/m)):
                d = D[i,c,y*m:y*m+alpha,x*m:x*m+alpha]
                v = B.T.dot(d).dot(B)
                b = i * (math.ceil(H/m) * math.ceil(W/m)) + y * (math.ceil(W/m)) + x
                for xi in range(alpha):
                    for nu in range(alpha):
                        V[xi][nu][c][b] = v[xi][nu]

M = np.empty(shape=(alpha, alpha, K, P))
for xi in range(alpha):
    for nu in range(alpha):
        M[xi][nu] = U[xi][nu].dot(V[xi][nu])

Y = np.empty(shape=(N, K, H, W))
temp_m = np.empty(shape=(alpha, alpha))
for i in range(N):
    for k in range(K):
        for y in range(math.ceil(H/m)):
            for x in range(math.ceil(W/m)):
                b = i * (math.ceil(H/m) * math.ceil(W/m)) + y * (math.ceil(W/m)) + x
                # gather
                for xi in range(alpha):
                    for nu in range(alpha):
                        temp_m[xi][nu] = M[xi][nu][k][b]
                Y[i,k,y*m:y*m+m,x*m:x*m+m] = A.T.dot(temp_m).dot(A)
            

for i in range(N):
    for k in range(K):
        for y in range(math.ceil(H/m)):
            for x in range(math.ceil(W/m)):
                b = i * (math.ceil(H/m) * math.ceil(W/m)) + y * (math.ceil(W/m)) + x
                print(k, b)
                print(Y[i,k,y*m:y*m+m,x*m:x*m+m])

